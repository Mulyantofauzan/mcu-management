<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Compliance Dashboard - MCU Management</title>
    <link rel="stylesheet" href="../css/output.css">
    <style>
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-button {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-button.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-content {
            display: none;
            margin-top: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .forensic-session {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f9fafb;
        }

        .forensic-header {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ip-badge {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .integrity-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .integrity-valid {
            background: #dcfce7;
            color: #166534;
        }

        .integrity-invalid {
            background: #fee2e2;
            color: #991b1b;
        }

        .change-detail {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            background: white;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .change-old {
            color: #dc2626;
            font-family: monospace;
        }

        .change-new {
            color: #059669;
            font-family: monospace;
        }

        .change-arrow {
            color: #9ca3af;
        }

        .report-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .report-card {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #2563eb;
        }

        .report-card-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .report-card-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .btn-secondary-outline {
            padding: 0.75rem 1.5rem;
            border: 2px solid #d1d5db;
            background: white;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-secondary-outline:hover {
            border-color: #6b7280;
            background: #f9fafb;
        }

        .archive-info {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .archive-info-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .archive-info-text {
            color: #b45309;
            font-size: 0.875rem;
        }

        table.audit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        table.audit-table thead {
            background: #f3f4f6;
        }

        table.audit-table th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        table.audit-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }

        table.audit-table tbody tr:hover {
            background: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed left-0 top-0 h-screen w-64 bg-white border-r border-gray-200 z-30">
        <div class="flex flex-col h-full">
            <!-- Logo -->
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-xl font-bold text-primary-600">MCU Management</h1>
                <p class="text-xs text-gray-500 mt-1">Medical Check Up System</p>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 overflow-y-auto p-4">
                <ul class="space-y-1">
                    <li>
                        <a href="../index.html" class="sidebar-link">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li id="menu-activity-log">
                        <a href="activity-log.html" class="sidebar-link">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>Activity Log</span>
                        </a>
                    </li>
                    <li id="menu-audit-compliance">
                        <a href="audit-compliance.html" class="sidebar-link active">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <span>Audit Compliance</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- User Info -->
            <div class="p-4 border-t border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center">
                        <span class="text-primary-600 font-semibold" id="user-initial">A</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900" id="user-name">Admin</p>
                        <p class="text-xs text-gray-500" id="user-role">Administrator</p>
                    </div>
                    <button onclick="window.handleLogout()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="ml-64 min-h-screen">
        <!-- Top Bar -->
        <div class="bg-white border-b border-gray-200">
            <div class="px-8 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-gray-900">Audit Compliance Dashboard</h1>
                    <button onclick="window.toggleMobileSidebar()" class="hidden md:hidden text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="p-8">
            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="tabs">
                    <button class="tab-button active" onclick="window.switchTab('overview')">
                        📊 Overview
                    </button>
                    <button class="tab-button" onclick="window.switchTab('forensics')">
                        🔍 Forensics
                    </button>
                    <button class="tab-button" onclick="window.switchTab('integrity')">
                        🔒 Integrity
                    </button>
                    <button class="tab-button" onclick="window.switchTab('retention')">
                        📦 Retention
                    </button>
                    <button class="tab-button" onclick="window.switchTab('reports')">
                        📄 Reports
                    </button>
                </div>

                <!-- Tab 1: Overview -->
                <div id="tab-overview" class="tab-content active p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Audit Trail Overview</h2>
                    <div id="overview-container" class="flex items-center justify-center py-12">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Tab 2: Forensics -->
                <div id="tab-forensics" class="tab-content p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Forensic Analysis</h2>
                    <div class="mb-4">
                        <label class="label">User ID</label>
                        <input type="text" id="forensic-user-id" class="input" placeholder="Enter user ID to analyze">
                        <button onclick="window.loadForensicTimeline()" class="btn btn-primary mt-2">Analyze Timeline</button>
                    </div>
                    <div id="forensic-container" class="mt-6"></div>
                </div>

                <!-- Tab 3: Integrity Check -->
                <div id="tab-integrity" class="tab-content p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Audit Trail Integrity Verification</h2>
                    <div class="archive-info mb-6">
                        <div class="archive-info-title">🔐 Immutability Check</div>
                        <div class="archive-info-text">All audit records are write-once and immutable. Hash verification ensures no tampering has occurred.</div>
                    </div>
                    <div id="integrity-container" class="flex items-center justify-center py-12">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Tab 4: Retention Policy -->
                <div id="tab-retention" class="tab-content p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Data Retention & Archival</h2>
                    <div class="archive-info mb-6">
                        <div class="archive-info-title">📋 Retention Policy</div>
                        <div class="archive-info-text">
                            Healthcare audit logs: 7 years (HIPAA compliance)<br>
                            Archive automatically when retention period exceeded<br>
                            Permanent deletion after full retention window
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="window.manualArchive()" class="export-btn">Archive Old Records</button>
                        <button onclick="window.viewArchive()" class="btn btn-secondary">View Archive</button>
                    </div>
                    <div id="retention-container" class="mt-6"></div>
                </div>

                <!-- Tab 5: Reports -->
                <div id="tab-reports" class="tab-content p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Compliance Reports</h2>
                    <div class="mb-4">
                        <label class="label">Report Period</label>
                        <div class="flex gap-4 mb-4">
                            <div>
                                <label class="text-sm text-gray-600">From</label>
                                <input type="date" id="report-start-date" class="input">
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">To</label>
                                <input type="date" id="report-end-date" class="input">
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="window.generateReport('json')" class="export-btn">📄 JSON Report</button>
                        <button onclick="window.generateReport('csv')" class="export-btn">📊 CSV Export</button>
                        <button onclick="window.generateReport('pdf')" class="export-btn">📑 PDF Report</button>
                    </div>
                    <div id="report-container" class="mt-6"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../env-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        import { database } from '../js/services/database.js';
        import { authService } from '../js/services/authService.js';
        import { showToast, hideAdminMenuForNonAdmin } from '../js/utils/uiHelpers.js';
        import { AuditService } from '../js/services/auditService.js';

        let auditService;
        let currentUser = null;

        // Initialize
        async function init() {
            try {
                // Check auth
                currentUser = await authService.getCurrentUser();
                if (!currentUser) {
                    window.location.href = '../index.html';
                    return;
                }

                // Check permission
                if (currentUser.role !== 'Admin') {
                    showToast('Anda tidak memiliki akses ke halaman ini', 'error');
                    window.location.href = '../index.html';
                    return;
                }

                // Update UI
                document.getElementById('user-name').textContent = currentUser.displayName || currentUser.username;
                document.getElementById('user-role').textContent = currentUser.role;
                document.getElementById('user-initial').textContent = (currentUser.displayName || currentUser.username).charAt(0).toUpperCase();

                hideAdminMenuForNonAdmin(currentUser);

                // Initialize audit service
                auditService = new AuditService(database);

                // Load overview
                await loadOverview();

            } catch (error) {
                console.error('Init error:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Load overview
        async function loadOverview() {
            try {
                const report = await auditService.generateAuditReport();
                const container = document.getElementById('overview-container');

                let html = '<div class="report-grid">';

                html += `
                    <div class="report-card">
                        <div class="report-card-title">Total Records</div>
                        <div class="report-card-value">${report.totalRecords}</div>
                    </div>
                `;

                Object.entries(report.recordsByAction).forEach(([action, records]) => {
                    html += `
                        <div class="report-card">
                            <div class="report-card-title">${action}</div>
                            <div class="report-card-value">${records.length}</div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;

            } catch (error) {
                showToast('Error loading overview: ' + error.message, 'error');
            }
        }

        // Switch tab
        window.switchTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        };

        // Load forensic timeline
        window.loadForensicTimeline = async function() {
            try {
                const userId = document.getElementById('forensic-user-id').value;
                if (!userId) {
                    showToast('Masukkan User ID', 'warning');
                    return;
                }

                const timeline = await auditService.getForensicTimeline(userId);
                const container = document.getElementById('forensic-container');

                if (Object.keys(timeline).length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Tidak ada aktivitas ditemukan</p>';
                    return;
                }

                let html = '';
                Object.entries(timeline).forEach(([ip, sessions]) => {
                    sessions.forEach(session => {
                        html += `
                            <div class="forensic-session">
                                <div class="forensic-header">
                                    <span><span class="ip-badge">${ip}</span> - ${session.activities.length} aktivitas</span>
                                    <span class="text-sm text-gray-500">${new Date(session.sessionStart).toLocaleString('id-ID')}</span>
                                </div>
                                ${session.activities.map(activity => `
                                    <div class="change-detail">
                                        <strong>${activity.action}</strong>
                                        ${activity.old_value ? `
                                            <span class="change-old">${activity.old_value}</span>
                                            <span class="change-arrow">→</span>
                                            <span class="change-new">${activity.new_value}</span>
                                        ` : `<span>${activity.target}</span>`}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    });
                });

                container.innerHTML = html;

            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        };

        // Manual archive
        window.manualArchive = async function() {
            try {
                showToast('Archiving records...', 'info');
                const result = await auditService.archiveOldRecords();
                showToast(`${result.archived} records archived`, 'success');
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        };

        // Generate report
        window.generateReport = async function(format) {
            try {
                const startDate = document.getElementById('report-start-date').value;
                const endDate = document.getElementById('report-end-date').value;

                const report = await auditService.exportAuditTrail(
                    { startDate, endDate },
                    format
                );

                if (format === 'csv') {
                    const blob = new Blob([report], { type: 'text/csv' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `audit-report-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                } else if (format === 'json') {
                    const blob = new Blob([report], { type: 'application/json' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `audit-report-${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                }

                showToast('Report generated', 'success');

            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        };

        window.handleLogout = function() {
            authService.logout();
        };

        window.addEventListener('load', init);
    </script>
</body>
</html>
