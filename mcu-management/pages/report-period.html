<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Periode MCU - MCU Management</title>

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="../assets/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/images/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/images/apple-touch-icon.png">
    <link rel="manifest" href="../assets/site.webmanifest">

    <link rel="stylesheet" href="../css/output.css">

    <!-- Environment Configuration -->
    <script src="../env-config.js"></script>

    <!-- Dexie (IndexedDB) - Fallback -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            opacity: 0;
            transition: opacity 0.2s ease-in;
        }

        body.initialized {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar loaded dynamically from templates/sidebar.html -->

    <!-- MAIN CONTENT -->
    <div class="ml-64 min-h-screen">
        <!-- HEADER -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-20">
            <div class="px-6 py-4">
                <nav class="flex">
                    <ol class="inline-flex items-center space-x-1">
                        <li><a href="../index.html" class="text-sm text-gray-500">Dashboard</a></li>
                        <li><span class="text-gray-400 mx-2">/</span></li>
                        <li><span class="text-sm font-medium text-gray-700">Laporan Periode</span></li>
                    </ol>
                </nav>
            </div>
        </header>

        <!-- MAIN -->
        <main class="p-6">
            <!-- PAGE TITLE -->
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Laporan Periode MCU</h1>
                <p class="text-gray-500">Laporan karyawan dan hasil MCU dalam periode tertentu</p>
            </div>

            <!-- FILTERS SECTION -->
            <div class="card mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Filter Laporan</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Start Date -->
                    <div>
                        <label for="filter-start-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label>
                        <input type="date" id="filter-start-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>

                    <!-- End Date -->
                    <div>
                        <label for="filter-end-date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
                        <input type="date" id="filter-end-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                    </div>

                    <!-- Department Filter -->
                    <div>
                        <label for="filter-department" class="block text-sm font-medium text-gray-700 mb-1">Departemen</label>
                        <select id="filter-department" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="">Semua Departemen</option>
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1">Status MCU</label>
                        <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="">Semua Status</option>
                            <option value="Fit">Fit</option>
                            <option value="Unfit">Unfit</option>
                            <option value="Follow-Up">Follow-Up</option>
                        </select>
                    </div>
                </div>

                <!-- Button Group -->
                <div class="flex gap-2 mt-4">
                    <button onclick="window.generateReport()" class="btn btn-primary">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Buat Laporan
                    </button>
                    <button onclick="window.exportToCSV()" class="btn btn-secondary" id="export-btn" disabled>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>

            <!-- STATISTICS SECTION -->
            <div id="statistics-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" style="display: none;">
                <div class="card">
                    <p class="text-sm text-gray-600 font-medium">Total Karyawan</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2" id="stat-total-employees">0</p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-600 font-medium">Total MCU</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2" id="stat-total-mcu">0</p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-600 font-medium">Fit</p>
                    <p class="text-3xl font-bold text-green-600 mt-2" id="stat-fit">0</p>
                    <p class="text-xs text-gray-500 mt-1" id="stat-fit-percent">0%</p>
                </div>
                <div class="card">
                    <p class="text-sm text-gray-600 font-medium">Unfit / Follow-Up</p>
                    <p class="text-3xl font-bold text-red-600 mt-2" id="stat-unfit">0</p>
                    <p class="text-xs text-gray-500 mt-1" id="stat-unfit-percent">0%</p>
                </div>
            </div>

            <!-- RESULTS TABLE -->
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">Hasil Laporan</h2>
                    <p class="text-sm text-gray-500" id="result-count"></p>
                </div>
                <div class="table-container" id="results-table">
                    <p class="text-center text-gray-500 py-8">Silakan isi filter dan klik "Buat Laporan" untuk melihat hasil</p>
                </div>
            </div>
        </main>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { authService } from '../js/services/authService.js';
        import { mcuService } from '../js/services/mcuService.js';
        import { employeeService } from '../js/services/employeeService.js';
        import { masterDataService } from '../js/services/masterDataService.js';
        import { showToast } from '../js/utils/uiHelpers.js';
        import { initializeSidebar, hideAdminMenus } from '../js/sidebar-manager.js';

        // Check authentication
        if (!authService.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Initialize page
        async function init() {
            // Wait for sidebar to load before accessing elements
            await window.waitForSidebar();

            const user = authService.getCurrentUser();
            if (user) {
                const displayName = user?.displayName || 'User';
                const role = user?.role || 'Petugas';
                const initial = (displayName && displayName.length > 0) ? displayName.charAt(0).toUpperCase() : '?';

                const userNameEl = document.getElementById('user-name');
                const userRoleEl = document.getElementById('user-role');
                const userInitialEl = document.getElementById('user-initial');

                if (userNameEl) userNameEl.textContent = displayName;
                if (userRoleEl) userRoleEl.textContent = role;
                if (userInitialEl) userInitialEl.textContent = initial;

                initializeSidebar(user);
                hideAdminMenus(user);
            }

            // Highlight active sidebar link
            const currentPage = 'report-period';
            document.querySelectorAll('.sidebar-link').forEach(link => {
                const dataPage = link.getAttribute('data-page');
                if (dataPage === currentPage) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // Load departments for filter
            try {
                const departments = await masterDataService.getAllDepartments();
                const select = document.getElementById('filter-department');
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load departments:', error);
            }

            // Set default dates (last 30 days)
            const endDate = new Date();
            const startDate = new Date(endDate.getTime() - 30 * 24 * 60 * 60 * 1000);

            document.getElementById('filter-start-date').valueAsDate = startDate;
            document.getElementById('filter-end-date').valueAsDate = endDate;
        }

        // Store report data and services globally
        window.reportData = [];
        window.mcuService = mcuService;
        window.employeeService = employeeService;
        window.masterDataService = masterDataService;
        window.showToast = showToast;

        // Cache for master data
        let deptCache = new Map();
        let jobTitleCache = new Map();

        // Generate report
        window.generateReport = async function() {
            try {
                const startDateStr = document.getElementById('filter-start-date').value;
                const endDateStr = document.getElementById('filter-end-date').value;
                const departmentId = document.getElementById('filter-department').value;
                const status = document.getElementById('filter-status').value;

                if (!startDateStr || !endDateStr) {
                    showToast('Silakan isi tanggal mulai dan akhir', 'warning');
                    return;
                }

                // Show loading
                const resultsTable = document.getElementById('results-table');
                resultsTable.innerHTML = '<p class="text-center text-gray-500 py-8">Memproses data...</p>';

                // Get MCUs in date range
                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);
                endDate.setHours(23, 59, 59, 999);

                const allMCUs = await mcuService.getAll();
                const filteredMCUs = allMCUs.filter(mcu => {
                    const mcuDate = new Date(mcu.mcuDate);
                    return mcuDate >= startDate && mcuDate <= endDate;
                });

                // Get all employees
                const employees = await employeeService.getAll();

                // Build report
                const report = [];
                const uniqueEmployees = new Set();

                for (const mcu of filteredMCUs) {
                    const employee = employees.find(e => e.employeeId === mcu.employeeId);
                    if (!employee) continue;

                    // Apply filters
                    if (departmentId && employee.departmentId !== parseInt(departmentId)) continue;
                    if (status && mcu.status !== status) continue;

                    uniqueEmployees.add(employee.employeeId);

                    // Get department from cache or fetch (ensure ID is string for consistency)
                    const deptId = String(employee.departmentId);
                    let dept = deptCache.get(deptId);
                    if (!dept) {
                        dept = await masterDataService.getDepartmentById(deptId);
                        if (dept) deptCache.set(deptId, dept);
                    }

                    // Get job title from cache or fetch (ensure ID is string for consistency)
                    const jobId = String(employee.jobTitleId);
                    let jobTitle = jobTitleCache.get(jobId);
                    if (!jobTitle) {
                        jobTitle = await masterDataService.getJobTitleById(jobId);
                        if (jobTitle) jobTitleCache.set(jobId, jobTitle);
                    }

                    report.push({
                        employeeId: employee.employeeId,
                        employeeName: employee.name,
                        department: (dept && dept.name) ? dept.name : 'N/A',
                        jobTitle: (jobTitle && jobTitle.name) ? jobTitle.name : 'N/A',
                        mcuDate: new Date(mcu.mcuDate).toLocaleDateString('id-ID'),
                        mcuType: mcu.mcuType || 'N/A',
                        status: mcu.status,
                        initialResult: mcu.initialResult,
                        finalResult: mcu.finalResult || '-',
                        notes: mcu.initialNotes || mcu.finalNotes || '-'
                    });
                }

                window.reportData = report;

                // Display results
                displayResults(report, uniqueEmployees.size);

                // Calculate and display statistics
                displayStatistics(report, uniqueEmployees.size);

                showToast('Laporan berhasil dibuat', 'success');
                document.getElementById('export-btn').disabled = false;
            } catch (error) {
                console.error('Error generating report:', error);
                showToast('Gagal membuat laporan: ' + error.message, 'error');
                document.getElementById('results-table').innerHTML = '<p class="text-center text-red-500 py-8">Terjadi kesalahan saat membuat laporan</p>';
            }
        };

        // Display results table
        function displayResults(data, totalEmployees) {
            const resultsTable = document.getElementById('results-table');

            if (data.length === 0) {
                resultsTable.innerHTML = '<p class="text-center text-gray-500 py-8">Tidak ada data untuk periode ini</p>';
                document.getElementById('result-count').textContent = '0 hasil';
                return;
            }

            let html = '<div class="table-container"><table class="table"><thead><tr>';
            html += '<th>No</th>';
            html += '<th>ID Karyawan</th>';
            html += '<th>Nama Karyawan</th>';
            html += '<th>Departemen</th>';
            html += '<th>Jabatan</th>';
            html += '<th>Tanggal MCU</th>';
            html += '<th>Tipe MCU</th>';
            html += '<th>Status</th>';
            html += '<th>Hasil Awal</th>';
            html += '<th>Hasil Akhir</th>';
            html += '</tr></thead><tbody>';

            data.forEach((row, idx) => {
                html += '<tr>';
                html += `<td><span class="text-sm text-gray-600">${idx + 1}</span></td>`;
                html += `<td><span class="text-sm text-gray-600">${row.employeeId}</span></td>`;
                html += `<td><span class="font-medium text-gray-900">${row.employeeName}</span></td>`;
                html += `<td><span class="text-sm text-gray-600">${row.department}</span></td>`;
                html += `<td><span class="text-sm text-gray-600">${row.jobTitle}</span></td>`;
                html += `<td><span class="text-sm text-gray-600">${row.mcuDate}</span></td>`;
                html += `<td><span class="text-sm text-gray-600">${row.mcuType}</span></td>`;
                html += `<td><span class="px-2 py-1 rounded text-xs font-medium ${getStatusBadgeClass(row.status)}">${row.status}</span></td>`;
                html += `<td><span class="text-sm text-gray-600">${row.initialResult}</span></td>`;
                html += `<td><span class="text-sm text-gray-600">${row.finalResult}</span></td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            resultsTable.innerHTML = html;
            document.getElementById('result-count').textContent = `${data.length} hasil`;
        }

        // Display statistics
        function displayStatistics(data, totalEmployees) {
            const statsSection = document.getElementById('statistics-section');
            statsSection.style.display = 'grid';

            const totalMCU = data.length;
            const fitCount = data.filter(d => d.status === 'Fit').length;
            const unfitCount = data.filter(d => d.status === 'Unfit' || d.status === 'Follow-Up').length;

            document.getElementById('stat-total-employees').textContent = totalEmployees;
            document.getElementById('stat-total-mcu').textContent = totalMCU;
            document.getElementById('stat-fit').textContent = fitCount;
            document.getElementById('stat-fit-percent').textContent = totalMCU > 0 ? ((fitCount / totalMCU) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('stat-unfit').textContent = unfitCount;
            document.getElementById('stat-unfit-percent').textContent = totalMCU > 0 ? ((unfitCount / totalMCU) * 100).toFixed(1) + '%' : '0%';
        }

        // Export to CSV
        window.exportToCSV = function() {
            if (window.reportData.length === 0) {
                showToast('Tidak ada data untuk diexport', 'warning');
                return;
            }

            const headers = ['No', 'ID Karyawan', 'Nama Karyawan', 'Departemen', 'Jabatan', 'Tanggal MCU', 'Tipe MCU', 'Status', 'Hasil Awal', 'Hasil Akhir', 'Catatan'];
            const rows = window.reportData.map((row, idx) => [
                idx + 1,
                row.employeeId,
                row.employeeName,
                row.department,
                row.jobTitle,
                row.mcuDate,
                row.mcuType,
                row.status,
                row.initialResult,
                row.finalResult,
                row.notes
            ]);

            const csv = [headers, ...rows].map(row =>
                row.map(cell => `"${cell.toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `laporan-mcu-${new Date().toISOString().split('T')[0]}.csv`);
            link.click();

            showToast('Laporan berhasil diexport', 'success');
        };

        // Get status badge class
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'Fit':
                    return 'bg-green-100 text-green-800';
                case 'Unfit':
                    return 'bg-red-100 text-red-800';
                case 'Follow-Up':
                    return 'bg-yellow-100 text-yellow-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Handle logout
        window.handleLogout = function() {
            authService.logout();
        };

        // Initialize
        init();
    </script>
</body>
</html>
